# utag

## 概要

MP3, FLACなどの音楽ファイルのタグとファイル名を一括編集するCLIツール。

## コンセプト

今日ではCDからのリッピングだけでなくダウンロード販売でもFLACなどの音源を入手できる。

販売サイトごとにタグとファイル名の付け方がバラバラなので、購入したままだと統一感がない。

そこで、所定のルールに沿うようにタグとファイル名を一括変更するツールとしてutagを開発した。

utagはUnified Tagの略。

## 対象とするファイル形式

- MP3
- FLAC
- M4A
- DSF

## 使い方

### 前提

- utagコマンドとして実行できるようにPATHが設定されている。
- カレントディレクトリに処理対象の音楽ファイルが配置されている。

### エクスポート

タグを設定するには、設定するタグをtagsファイルに書く。

これを1から手書きする手間を省くために、今設定されているタグからtagsファイルを出力するエクスポート機能がある。

`$ utag e`

でエクスポートを実行する。

アートワークが設定されていれば、それもFolder.jpg / Folder.pngなどの名前で出力する。

### インポート

tagsファイルと（設定するなら）アートワークのFolder.jpgまたはFolder.pngを同じディレクトリに配置する。

tagsファイルの書き方は後述する。

`$ utag i`

でタグとアートワークを設定するインポートを実行する。

### リネーム

ファイル名を変更するリネームは以下のように実行する。

`$ utag r`

リネームすると以下の書式でファイル名を変更する。

{トラック番号}.{タイトル}.{拡張子}

タイトルにファイル名に使えない文字が含まれている場合は空白に置き換えたり削除したりする。

この仕様の詳細は割愛する。

ディスク枚数が2つ以上だと、ファイル名の先頭に

{ディスク番号}.

も付与する。

## tagsファイルの仕様

UTF-8（BOMなし）かつ改行コードLFのテキストファイル。

例）

```
歌物語 -<物語>シリーズ主題歌集-
物語シリーズ
2016-01-06

staple stable//斎藤千和
帰り道//加藤英美里
ambivalent world//沢城みゆき
恋愛サーキュレーション//花澤香菜
sugar sweet nightmare//堀江由衣
君の知らない物語//supercell
二言目//斎藤千和
marshmallow justice//喜多村英梨
白金ディスコ//井口裕香
ナイショの話//ClariS
perfect slumbers//堀江由衣
消えるdaydream//河野マリナ

chocolate insomnia//堀江由衣
happy bite//加藤英美里
アイヲウタエ//春奈るな
the last day of my adolescence//沢城みゆき
花痕 -shirushi-//河野マリナ
もうそう♡えくすぷれす//花澤香菜
white lies
その声を覚えてる//河野マリナ
fast love//斎藤千和
木枯らしセンティメント//斎藤千和//三木眞一郎
snowdrop//春奈るな//河野マリナ
```

1行目はアルバム名。

2行目はアルバムアーティスト名。  
アルバムアーティスト名を書くとアーティスト名のタグにも設定される。

3行目は発売日。  
yyyy-mm-dd形式が基本だがそのまま設定するだけなので違ってもエラーにはならない。

4行目は空白行。  
1～3行目は未設定でよければ空白行にしてもよいが、4行目が空白行で5行目からトラック情報である形は崩さないこと。

5行目からはトラック情報で、基本的にはタイトルのみ。  
曲ごとのアーティスト名を設定したければ//で区切ってタイトルの後に書く。  
複数のアーティストを設定できる。

ディスクが複数枚のアルバムならディスク番号が切り替わるところで空白行を入れる。

### ディレクトリの指定

いずれのコマンドもディレクトリを指定することでカレントディレクトリ以外を対象にできる。

`utag e "/music/物語シリーズ/歌物語 -<物語>シリーズ主題歌集-"`

## ファイル形式ごとの設定されるタグの詳細

### MP3 & DSF

エクスポートではID3v2.3およびID3v2.4で設定されたタグを読み込む。

インポートではID3v2.4で設定する。  
既存のID3v2はすべて削除する。  
APEはそのまま。

- TALB: アルバム名
- TPE2: アルバムアーティスト名
- TDRL: 発売日
- TPOS: ディスク番号/総ディスク数
- TRCK: トラック番号/総トラック数
- TIT2: タイトル
- TPE1: アーティスト名(\00区切りで1つのタグに設定)
- APIC: アートワークをフロントカバーとして設定

### FLAC

インポートでは既存のタグとパディングはすべて削除する。  
（パディングは何も情報が記録されない領域で再生などには影響しない）  

- ALBUM: アルバム名
- ALBUMARTIST: アルバムアーティスト名
- DATE: 発売日
- DISCNUMBER: ディスク番号
- DISCTOTAL: 総ディスク数
- TRACKNUMBER: トラック番号
- TRACKTOTAL: 総トラック数
- TITLE: タイトル
- ARTIST: アーティスト名（件数分）

### M4A

インポートでは既存のタグはすべて削除する。

- ©alb: アルバム名
- aART: アルバムアーティスト名
- ©day: 発売日
- trkn: ディスク番号 総ディスク数
- disk: トラック番号 総トラック数
- ©nam: タイトル
- ©ART: アーティスト名（件数分）
- covr: アートワークを設定

## インストール

パッケージマネージャーを使わないならGitHubからダウンロードした  
utag-vX.X.X.zipを展開して動作環境にあったバイナリを利用する。

- macOS Intel: utag-darwin-amd64-vX.X.X
- macOS ARM(M1など): utag-darwin-arm64-vX.X.X
- Linux 32bit: utag-linux-386-vX.X.X
- Linux 64bit: utag-linux-amd64-vX.X.X
- Windows 32bit: utag-windows-386-vX.X.X.exe
- Windows 64bit: utag-windows-amd64-vX.X.X.exe

## 制限事項

同じ曲に複数のアーティストが設定されていてもエクスポートでは1人しか出力されない場合がある。

非同期のID3v2（普通はそうではない）からアートワークをエクスポートできない。

## 開発

### 利用した製品、サービス、開発環境など

Pythonで作る方が簡単だが、実行にインタプリタを必要とする言語で開発するとユーザーのインストール作業が煩雑になる。  
そのためネイティブコンパイル可能な言語からGoを採用した。

WSLにインストールしたUbuntuとVSCodeを連携させて開発した。

### 雑感

要求は単純なので容易に開発できると思ったが、タグを操作するライブラリに満足のいくものが見つからず苦戦した。

昔Pythonで同じツールを作った時はMutagenという高機能で使いやすいライブラリがあったため簡単だったがGoではそうはいかなかった。

特にM4AはMP4という動画フォーマットの拡張らしく、仕様が他よりも複雑で、  
ライブラリも低レベルな操作を行うものしかないのでその仕様まで理解していないと使えなかった。

資料だけでは理解できなかったのでライブラリのソースを読んだり実際のファイルの中身をPythonで調べることで補った。

### 開発期間

およそ10日間でプロダクトそのものは開発した。

README.mdの記載内容を整理するなど公開するに当たっての作業に数日追加でかかっている。

### 今後の予定

不具合があれば対応する保守以外は特になし。
